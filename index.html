<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>AsciiTracker</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⌨️</text></svg>">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="effects.css">
    <script src="effects.js"></script>
</head>

<body>

    <h1>AsciiTracker</h1>
    <div class="stats" id="status-text">Detecting keystrokes...</div>

    <div class="main-console">
        <div id="group-left" class="side-panel mod-panel"></div>

        <div class="matrix-center">
            <div class="matrix" id="matrix"></div>
        </div>

        <div id="group-right" class="side-panel right-panel">
            <div id="group-act" class="act-group"></div>

            <div id="group-arrow" class="arrow-group"></div>
        </div>
    </div>

    <script>
        const matrix = document.getElementById('matrix');
        const specCon = document.getElementById('special-container');
        const keyMap = {};

        // 1. ラベル作成用
        const createLabel = (text) => {
            const div = document.createElement('div');
            div.className = 'cell label';
            div.innerText = text;
            return div;
        };

        // 2. マトリックスヘッダー
        matrix.appendChild(createLabel('HEX'));
        for (let i = 0; i < 16; i++) matrix.appendChild(createLabel(i.toString(16).toUpperCase()));

        // 3. ASCIIマトリックス生成
        for (let row = 0x2; row <= 0x7; row++) {
            matrix.appendChild(createLabel(row.toString(16).toUpperCase() + '_'));
            for (let col = 0; col < 16; col++) {
                const code = (row << 4) | col;
                if (code > 127) {
                    const empty = document.createElement('div');
                    empty.className = 'cell';
                    matrix.appendChild(empty);
                    continue;
                }

                let char;
                if (code === 32) char = 'SP';
                else if (code === 127) char = 'Del'
                else char = String.fromCharCode(code);

                const div = document.createElement('div');
                div.className = 'cell key-box';
                div.id = `key-${code}`;
                div.innerHTML = `<span class="hex-id">0x${code.toString(16).toUpperCase()}</span><span class="char">${char}</span>`;
                matrix.appendChild(div);

                keyMap[code] = { count: 0, element: div };
                //if (code === 127) keyMap['Delete'] = keyMap[code];
            }
        }

        // 4. 特殊キーの定義（event.key の値と一致させる）
        const specials = [
            { id: 'Escape', label: 'ESC', hex: '1B', cls: 'k-esc', grp: 'left' },
            { id: 'Backspace', label: 'BS', hex: '08', cls: 'k-bs', grp: 'act' },
            { id: 'Tab', label: 'TAB', hex: '09', cls: 'k-tab', grp: 'left' },
            { id: 'Enter', label: 'ENTER', hex: '0D', cls: 'k-ent', grp: 'act' },
            { id: 'Shift', label: 'SHIFT', hex: 'MOD', cls: 'k-shft', grp: 'left' },
            { id: 'Control', label: 'CTRL', hex: 'MOD', cls: 'k-ctrl', grp: 'left' },
            { id: 'Alt', label: 'ALT', hex: 'MOD', cls: 'k-alt', grp: 'left' },
            { id: 'Meta', label: 'META', hex: 'OS', cls: 'k-meta', grp: 'left' },
            { id: 'ArrowUp', label: '▲', hex: 'UP', cls: 'k-up', grp: 'arrow' },
            { id: 'ArrowDown', label: '▼', hex: 'DN', cls: 'k-down', grp: 'arrow' },
            { id: 'ArrowLeft', label: '◀', hex: 'LF', cls: 'k-left', grp: 'arrow' },
            { id: 'ArrowRight', label: '▶', hex: 'RT', cls: 'k-right', grp: 'arrow' }
        ];

        specials.forEach(s => {
            const div = document.createElement('div');
            div.className = `cell key-box special-key ${s.cls}`;
            div.id = `key-${s.id}`;
            div.innerHTML = `<span class="hex-id">${s.hex}</span><span class="char">${s.label}</span>`;

            const target = document.getElementById(`group-${s.grp}`);
            if (target) target.appendChild(div);

            keyMap[s.id] = { count: 0, element: div };
        });

        // 5. 入力イベント
        let totalPressed = 0;
        const totalTargets = Object.keys(keyMap).length;

        window.addEventListener('keydown', (event) => {
            let targetKey = null;
            console.log("key: %s / code: %s", event.key, event.code, event);

            // 特殊キーか、通常の1文字キーか判定
            if (keyMap[event.key]) {
                targetKey = event.key; // Backspace, Enter, Delete etc.
            } else if (event.key === 'Delete') {
                targetKey = 127;
            } else if (event.key.length === 1) {
                const code = event.key.charCodeAt(0);
                if (keyMap[code]) targetKey = code;
            }

            if (targetKey !== null) {
                const data = keyMap[targetKey];

                if (data.count === 0) {
                    totalPressed++;
                    data.element.classList.add('pressed');
                }
                data.count++;

                // アニメーション
                data.element.classList.add('active');
                setTimeout(() => data.element.classList.remove('active'), 100);

                // ステータス更新
                document.getElementById('status-text').innerText = `TRACKED: ${totalPressed} / ${totalTargets} | LAST_KEY: ${event.key}`;

                // ブラウザのショートカットや移動を防止
                const preventKeys = ['Tab', 'Backspace', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Meta'];
                if (preventKeys.includes(event.key)) {
                    event.preventDefault();
                }

                if (totalPressed === totalTargets) {
                    triggerCompleteEffect();
                }
            }
        });
    </script>

    <aside>
        表記外のキーイベントを見たい場合はコンソールログをご確認ください。
    </aside>

    <footer class="footer">
        <div class="footer-content">
            <span>&copy; 2026 <strong>AsciiTracker</strong></span>
            <span class="divider">|</span>
            <span>Developed by <a href="https://github.com/Yuta-shuh" target="_blank">Yuta</a></span>
            <span class="divider">|</span>
            <a href="https://github.com/Yuta-shuh/asciiTracker" target="_blank" class="github-link">
                GitHub Repository
            </a>
        </div>
    </footer>
</body>

</html>